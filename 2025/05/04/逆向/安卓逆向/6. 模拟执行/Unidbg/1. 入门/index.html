

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/fluid.png">
  <link rel="icon" href="/blog/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="HookAllUnidbg.pdf:  github：https:&#x2F;&#x2F;github.com&#x2F;zhkl0228&#x2F;unidbg 实战undibg：https:&#x2F;&#x2F;gitee.com&#x2F;yangyin_g&#x2F;unidbg 入门参考： https:&#x2F;&#x2F;www.yuque.com&#x2F;lilac-2hqvv&#x2F;xdwlsg&#x2F;gmbn45b5n6g59kks? https:&#x2F;&#x2F;www.yuque.com&#x2F;lilac-">
<meta property="og:type" content="article">
<meta property="og:title" content="杨颖的博客">
<meta property="og:url" content="http://example.com/2025/05/04/%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/6.%20%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/Unidbg/1.%20%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="杨颖的博客">
<meta property="og:description" content="HookAllUnidbg.pdf:  github：https:&#x2F;&#x2F;github.com&#x2F;zhkl0228&#x2F;unidbg 实战undibg：https:&#x2F;&#x2F;gitee.com&#x2F;yangyin_g&#x2F;unidbg 入门参考： https:&#x2F;&#x2F;www.yuque.com&#x2F;lilac-2hqvv&#x2F;xdwlsg&#x2F;gmbn45b5n6g59kks? https:&#x2F;&#x2F;www.yuque.com&#x2F;lilac-">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/blog/images/android/%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/HookAllInUnidbg.png">
<meta property="article:published_time" content="2025-05-04T08:18:17.247Z">
<meta property="article:modified_time" content="2025-05-04T09:17:30.519Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/blog/images/android/%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/HookAllInUnidbg.png">
  
  
  
  <title>杨颖的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/blog/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/blog/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/blog/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/blog/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/blog/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/blog/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/blog/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-04 16:18" pubdate>
          2025年5月4日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          29 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header"></h1>
            
            
              <div class="markdown-body">
                
                <ul>
<li>HookAllUnidbg.pdf: <img src="/blog/images/android/%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/HookAllInUnidbg.png" srcset="/blog/img/loading.gif" lazyload></li>
<li>github：<a target="_blank" rel="noopener" href="https://github.com/zhkl0228/unidbg">https://github.com/zhkl0228/unidbg</a></li>
<li>实战undibg：<a target="_blank" rel="noopener" href="https://gitee.com/yangyin_g/unidbg">https://gitee.com/yangyin_g/unidbg</a></li>
<li>入门参考：<ul>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/lilac-2hqvv/xdwlsg/gmbn45b5n6g59kks">https://www.yuque.com/lilac-2hqvv/xdwlsg/gmbn45b5n6g59kks</a>?</li>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/lilac-2hqvv/lfssh8/ibfh81">https://www.yuque.com/lilac-2hqvv/lfssh8/ibfh81</a>?</li>
</ul>
</li>
</ul>
<h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><h3 id="进程名"><a href="#进程名" class="headerlink" title="进程名"></a>进程名</h3><ul>
<li>setProcessName用于设置 App 进程名，<code>很多人 会忽略做这一设置，但最好设置一下，否则会带来风险</code>。<code>因为样本可以在代码中通过getprogname函数获取进程名</code></li>
<li>如果通过setProcessName设置了进程名，<code>那么getprogname会返回你所设置的进程名，而如果不设置进程名，Unidbg 会设置进程名为自身，这可不是很妙</code>。<blockquote>
<p>this.processName &#x3D; processName &#x3D;&#x3D; null ? “unidbg” : processName;</p>
</blockquote>
</li>
</ul>
<h3 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h3><blockquote>
<p><code>addBackendFactory</code>用于设置后端执行引擎</p>
<p><code>Backend 扮演的角色是处理器</code>，承担模拟执行机器指令的任务。addBackendFactory用于设置使用哪一个后端Unidbg </p>
<p>目前支持五个 Backend，分别是 <code>Unicorn、Unicorn2、Dynarmic、Hypervisor、KVM</code>。如果不添加 BackendFactory，<code>默认使用 Unicorn Backend</code></p>
<p><code>各种 BackendFactory 的构造方法都要传入fallbackUnicorn参数</code>，它表示如果<strong>这个后端创建失败时如何处理</strong>。如果设置为 false，那么 backend 创建失败时直接报错；设置为 true，返回 null，最终使用默认的 Unicorn Backend。</p>
</blockquote>
<ul>
<li><code>如果是算法分析，选择Unicorn后端，因为 提供的各种强大 Hook</code></li>
<li>相比较 Unicorn 后端，Unidbg 基于 <code>Unicorn2 后端设计和处理了多线程的相关逻辑</code>，因此在 Unicorn 和 Unicorn2 之间，应该选择 Unicorn 2</li>
<li>如果是模拟执行用于<code>rpc，选择 Dynarmic 作为可选后端，速度快，但是不支持各种各样的 Hook</code></li>
<li>如果你使用 Unidbg 的意图是<code>模拟执行，替代 RPC，那么你仍然应该先试 Unicorn2 后端，因为 Unicorn2 在模拟执行指令上的能力更强，如果 Unicorn2 最终能顺利跑通、跑出预期结果，再切换为 Dynarmic 看是否也能处理成功</code>，<code>如果 Unicorn2 跑不通，那么 Dynarmic 引擎也必然无法成功</code>。需要强调的是，_使用 Dynarmic 引擎时，不可使用基于 Unicorn 的 各种 Hook，而应该用内置适配的 HookZz、xHook 等框架_。</li>
<li>关于速度：<ul>
<li>Unicorn 最慢，Dynarmic 比 Unicorn 快 50 -100 倍，真机比 Dynarmic 快 5 - 30 倍，因为测试机性能差异很大。</li>
<li>最后，为了提高效率，<code>光用 Dynarmic 是不够的，还会搭配 unidbg-boot-server</code></li>
<li>KVM 和 Hypervisor 都是虚拟化而非模拟执行方案，所以对宿主机有较高要求，KVM 可用于 Raspberry Pi B4 等环境 ，速度快。</li>
<li>Hypervisor 是 Mac M1上的虚拟化方案，是 Unidbg 上最快的后端。</li>
<li>KVM 和 Hypervisor 都很快很快，但受制于宿主机设备限制，在 Unidbg 实际使用中不多见</li>
</ul>
</li>
</ul>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ada">emulator = AndroidEmulatorBuilder.for32Bit()<br>        .addBackendFactory(<span class="hljs-keyword">new</span> Unicorn2Factory(<span class="hljs-literal">false</span>))<br>        //.addBackendFactory(<span class="hljs-keyword">new</span> DynarmicFactory(<span class="hljs-literal">true</span>))<br>        .setProcessName(<span class="hljs-string">&quot;test&quot;</span>)<br>        .build();<br></code></pre></td></tr></table></figure>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><ul>
<li>Unidbg 在 Unicorn2 后端上实现了相对完善的多线程处理逻辑，如果读者希望开启多线程，除了要将 Backend 设置为 Unicorn2 外，还需要在模拟器初始化后通过<code>setEnableThreadDispatcher</code>开启多线程调度，以及设置线程切换条件<code>registerEmuCountHook</code>。<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">emulator = AndroidEmulatorBuilder.for32Bit<span class="hljs-params">()</span><br>        <span class="hljs-string">.addBackendFactory</span><span class="hljs-params">(new Unicorn2Factory(false)</span>)<br>        <span class="hljs-string">.setProcessName</span><span class="hljs-params">(&quot;test&quot;)</span><br>        <span class="hljs-string">.build</span><span class="hljs-params">()</span>;<br><span class="hljs-string">//</span> 设置执行多少条指令切换一次线程<br>emulator.getBackend<span class="hljs-params">()</span><span class="hljs-string">.registerEmuCountHook</span><span class="hljs-params">(10000)</span>;<br><span class="hljs-string">//</span> 开启线程调度器<br>emulator.getSyscallHandler<span class="hljs-params">()</span><span class="hljs-string">.setEnableThreadDispatcher</span><span class="hljs-params">(true)</span>;<br></code></pre></td></tr></table></figure></li>
<li><code>个人建议在模拟执行相对复杂的样本时，就打开多线程；如果样本难度一般，就不必打开</code></li>
</ul>
<h3 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h3><ul>
<li>参考：<a target="_blank" rel="noopener" href="https://www.yuque.com/lilac-2hqvv/xdwlsg/yaxqgh">https://www.yuque.com/lilac-2hqvv/xdwlsg/yaxqgh</a></li>
</ul>
<h4 id="常规日志"><a href="#常规日志" class="headerlink" title="常规日志"></a>常规日志</h4><ul>
<li>Unidbg 基于模块去管理输出，想了解哪部分日志，就指定具体的类为 DEBUG 等级<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">import</span> org.apache.log4j.<span class="hljs-keyword">Level</span>;<br><span class="hljs-keyword">import</span> org.apache.log4j.Logger;<br><br><span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args) &#123;<br>    NetWork nw = <span class="hljs-built_in">new</span> NetWork();<br>    Logger.getLogger(ARM32SyscallHandler.<span class="hljs-keyword">class</span>).setLevel(<span class="hljs-keyword">Level</span>.<span class="hljs-keyword">DEBUG</span>);<br>    Logger.getLogger(AndroidSyscallHandler.<span class="hljs-keyword">class</span>).setLevel(<span class="hljs-keyword">Level</span>.<span class="hljs-keyword">DEBUG</span>);<br>    String result = nw.callSign();<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;call s result:&quot;+result);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>如果你希望输出所有模块的日志，可以修改unidbg-android&#x2F;src&#x2F;test&#x2F;resources&#x2F;log4j.properties文件，将 unidbg 的日志等级从 INFO 改为 DEBUG；那么不管是系统调用、指针管理、多线程，还是多线程处理器等等，所有组件的日志都会打印出来</li>
</ul>
<h4 id="虚拟机日志"><a href="#虚拟机日志" class="headerlink" title="虚拟机日志"></a>虚拟机日志</h4><ul>
<li>除了常规日志，Unidbg 还有另一套日志输出，主要打印 JNI 、Syscall 调用相关的内容。它和常规日志的输出有重叠，但内容更详细一些； vm.setVerbose 开启或关闭它。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">WeiBo</span><span class="hljs-params">()</span> &#123;<br>    emulator = AndroidEmulatorBuilder<br>        .for32Bit()<br>        .addBackendFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Unicorn2Factory</span>(<span class="hljs-literal">true</span>))<br>        .setProcessName(<span class="hljs-string">&quot;com.weico.international&quot;</span>)<br>        .build();<br>    <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> emulator.getMemory();<br>    memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br>    vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android/src/test/resources/weibo/sinaInternational.apk&quot;</span>));<br>    vm.setJni(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-comment">// 设置是否打印以 JNI 为主的虚拟机调用细节</span><br>    vm.setVerbose(<span class="hljs-literal">false</span>);<br>    <span class="hljs-type">DalvikModule</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span> vm.loadLibrary(<span class="hljs-string">&quot;utility&quot;</span>, <span class="hljs-literal">true</span>);<br>    WeiboSecurityUtils = vm.resolveClass(<span class="hljs-string">&quot;com/sina/weibo/security/WeiboSecurityUtils&quot;</span>);<br>    dm.callJNI_OnLoad(emulator);<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h1 id="加载模块"><a href="#加载模块" class="headerlink" title="加载模块"></a>加载模块</h1><h3 id="加载apk"><a href="#加载apk" class="headerlink" title="加载apk"></a>加载apk</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//创建虚拟机</span><br><span class="hljs-type">VM</span> <span class="hljs-variable">dalvikVM</span> <span class="hljs-operator">=</span> emulator.createDalvikVM();<br><span class="hljs-comment">//创建虚拟机并指定APK文件</span><br><span class="hljs-type">VM</span> <span class="hljs-variable">dalvikVM</span> <span class="hljs-operator">=</span> emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;apk file path&quot;</span>));<br></code></pre></td></tr></table></figure>
<ul>
<li>Unidbg 加载 apk 做了什么<blockquote>
<p>一是解析 apk 信息，减少使用者在补 JNI 环境上的工作量。Unidbg 会解析版本名、版本号、包名等信息，如果样本通过 JNI 访问和获取这些信息，Unidbg 会替我们处理，不需要我们烦心</p>
<p>二是Unidbg 还会解析 Apk 签名，处理签名校验相关的 JNI 调用</p>
<p>三是对资源文件的处理，如果加载了 apk，就可以在 Unidbg 中访问 apk assets 目录下的文件</p>
<p>如果没有传入apk，这些需要我们手动补</p>
</blockquote>
</li>
</ul>
<h3 id="加载模块-1"><a href="#加载模块-1" class="headerlink" title="加载模块"></a>加载模块</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//参数一: 动态库或可执行ELF文件</span><br><span class="hljs-comment">//参数二: 是否强制执行 init_proc、init_array 初始化系列函数</span><br><span class="hljs-function">DalvikModule <span class="hljs-title">loadLibrary</span><span class="hljs-params">(<span class="hljs-built_in">File</span> elfFile, <span class="hljs-type">boolean</span> forceCallInit)</span></span>;<br><br><span class="hljs-comment">//参数一：动态库或可执行ELF文件名，比如 libkwsgmain.so 其名就是 kwsgmain，</span><br><span class="hljs-comment">//Unibdg 会在 apk lib 目录下找到和加载它</span><br><span class="hljs-comment">//参数二: 是否强制执行 init_proc、init_array 初始化系列函数</span><br><span class="hljs-function">DalvikModule <span class="hljs-title">loadLibrary</span><span class="hljs-params">(<span class="hljs-type">String</span> libname, <span class="hljs-type">boolean</span> forceCallInit)</span></span>;<br></code></pre></td></tr></table></figure>

<h3 id="加载依赖"><a href="#加载依赖" class="headerlink" title="加载依赖"></a>加载依赖</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 模拟器的内存操作接口</span><br><span class="hljs-keyword">final</span> <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> emulator.getMemory();<br><span class="hljs-comment">// 设置系统类库解析</span><br>memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br></code></pre></td></tr></table></figure>
<ul>
<li>我们一般使用 sdk23，读者可能认为 Android 6.0 的运行库环境太低了，但事实上，对于 Native Runtime 而言，似乎已然够用，如果读者希望使用更高的版本，并非将真机的 SO 放到 Unidbg 就大功告成，Unidbg 为这两个 SDK 环境做了一些优化和 patch 处理，参考文档</li>
</ul>
<h1 id="发起调用"><a href="#发起调用" class="headerlink" title="发起调用"></a>发起调用</h1><ul>
<li>我们想对s发起调用，因为它的返回值是字符串，是对象，所以用callJniMethodObject，如果返回值是 int 就用callJniMethodInt</li>
<li>如果s是静态方法，那么自然不需要 newObject，调用则通过 callStaticJNIMethodXXX 系列函数</li>
</ul>
<h3 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h3><ul>
<li>参数传递 <ul>
<li>参数 1 是字符串，参数 2 是布尔值，直接传递即可，不需要做其他处理，两大类参数都可以直接传递。 </li>
<li>● 基本类型直接传递，int、long、boolean、double 等。 </li>
<li>● 下面几种对象类型也可以直接传递 <ul>
<li>○ String </li>
<li>○ byte 数组 </li>
<li>○ short 数组 </li>
<li>○ int 数组 </li>
<li>○ float 数组 </li>
<li>○ double 数组 </li>
<li>○ Enum 枚举类型</li>
</ul>
</li>
<li>除此之外还有许多种可能的参数，比如字符串数组、二维数组、Android Context&#x2F;Application、HashMap 等等，在大体上遵循两类处理办法。 <ul>
<li>如果是 JDK 中包含的类库和方法，比如二维数组、字符串数组、HashMap 等等，直接构造然后使用ProxyDvmObject.createObject(vm, obj);构造出对象。除此之外比如 Okhttp3 之类的第三方类库，导入到本地环境里，也可以使用这个办法。 </li>
<li>如果是 JDK 中无法包含的类库，比如 Android FrameWork 以及样本自定义的类库，通过resolveClass(className).newObject处理，就像本节的NativeApi那样处理。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="调用so不同方法"><a href="#调用so不同方法" class="headerlink" title="调用so不同方法"></a>调用so不同方法</h3><ul>
<li>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38851536/article/details/117418582">https://blog.csdn.net/qq_38851536/article/details/117418582</a></li>
</ul>
<h4 id="通过伪造内存块，主动调用一个native-inline方法"><a href="#通过伪造内存块，主动调用一个native-inline方法" class="headerlink" title="通过伪造内存块，主动调用一个native inline方法"></a>通过伪造内存块，主动调用一个native inline方法</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">callMd5</span><span class="hljs-params">()</span></span>&#123;<br>    List&lt;Object&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-comment">// arg1</span><br>    <span class="hljs-type">String</span> input = <span class="hljs-string">&quot;r0ysue&quot;</span>;<br>    <span class="hljs-comment">// malloc memory</span><br>    MemoryBlock memoryBlock1 = emulator.<span class="hljs-built_in">getMemory</span>().<span class="hljs-built_in">malloc</span>(<span class="hljs-number">16</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// get memory pointer</span><br>    UnidbgPointer input_ptr=memoryBlock<span class="hljs-number">1.</span><span class="hljs-built_in">getPointer</span>();<br>    <span class="hljs-comment">// write plainText on it</span><br>    input_ptr.<span class="hljs-built_in">write</span>(input.<span class="hljs-built_in">getBytes</span>(StandardCharsets.UTF_8));<br><br>    <span class="hljs-comment">// arg2</span><br>    <span class="hljs-type">int</span> input_length = input.<span class="hljs-built_in">length</span>();<br><br>    <span class="hljs-comment">// arg3 -- buffer</span><br>    MemoryBlock memoryBlock2 = emulator.<span class="hljs-built_in">getMemory</span>().<span class="hljs-built_in">malloc</span>(<span class="hljs-number">16</span>, <span class="hljs-literal">false</span>);<br>    UnidbgPointer output_buffer=memoryBlock<span class="hljs-number">2.</span><span class="hljs-built_in">getPointer</span>();<br><br>    <span class="hljs-comment">// 填入参入</span><br>    list.<span class="hljs-built_in">add</span>(input_ptr);<br>    list.<span class="hljs-built_in">add</span>(input_length);<br>    list.<span class="hljs-built_in">add</span>(output_buffer);<br>    <span class="hljs-comment">// run</span><br>    <span class="hljs-keyword">module</span>.<span class="hljs-built_in">callFunction</span>(emulator, <span class="hljs-number">0x65540</span> + <span class="hljs-number">1</span>, list.<span class="hljs-built_in">toArray</span>());<br>    <span class="hljs-comment">// print arg3</span><br>    Inspector.<span class="hljs-built_in">inspect</span>(output_buffer.<span class="hljs-built_in">getByteArray</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x10</span>), <span class="hljs-string">&quot;output&quot;</span>);<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="通过执行so地址"><a href="#通过执行so地址" class="headerlink" title="通过执行so地址"></a>通过执行so地址</h4><ul>
<li>注意：地址方式调用，<code>ARM32有Thumb和ARM两种指令模式，此处是thumb模式，所以地址要在start基础上+1。</code></li>
<li>如何判断是thumb还是arm：<a target="_blank" rel="noopener" href="https://note.youdao.com/s/YRqEYgZn">https://note.youdao.com/s/YRqEYgZn</a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.lession1;<br><br><span class="hljs-comment">// 导入通用且标准的类库</span><br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.AbstractJni;<br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.Module;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.*;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.array.ByteArray;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">// 继承AbstractJni类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">oasis</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Module <span class="hljs-keyword">module</span>;<br><br>    oasis() &#123;<br>        <span class="hljs-comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span><br>        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="hljs-string">&quot;com.sina.oasis&quot;</span>).build();<br>        <span class="hljs-comment">// 获取模拟器的内存操作接口</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> emulator.getMemory();<br>        <span class="hljs-comment">// 设置系统类库解析</span><br>        memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br>        <span class="hljs-comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span><br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android\\src\\test\\java\\com\\lession1\\lvzhou.apk&quot;</span>));<br>        <span class="hljs-comment">//</span><br><span class="hljs-comment">//        vm = emulator.createDalvikVM(null);</span><br><br>        <span class="hljs-comment">// 加载目标SO</span><br>        <span class="hljs-type">DalvikModule</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span> vm.loadLibrary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android\\src\\test\\java\\com\\lession1\\liboasiscore.so&quot;</span>), <span class="hljs-literal">true</span>); <span class="hljs-comment">// 加载so到虚拟内存， 参数二设为false(即不执行init相关函数)</span><br>        <span class="hljs-comment">//获取本SO模块的句柄,后续需要用它</span><br>        <span class="hljs-keyword">module</span> = dm.getModule();<br>        vm.setJni(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 设置JNI</span><br>        vm.setVerbose(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 打印日志</span><br><br>        dm.callJNI_OnLoad(emulator); <span class="hljs-comment">// 调用JNI OnLoad</span><br>    &#125;;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">oasis</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">oasis</span>();<br>        System.out.println(test.getS());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getS</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// args list</span><br>        List&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">// arg1 env</span><br>        list.add(vm.getJNIEnv());<br>        <span class="hljs-comment">// arg2 jobject/jclazz 一般用不到，直接填0                </span><br>        list.add(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 如果用的第二个参数&lt;jObject/jClass&gt;, 则需要如此伪造。这里需要参考getmethodid问题</span><br>        <span class="hljs-comment">// 如果是静态方法，是jclass，即不需要new；</span><br>        <span class="hljs-comment">// DvmObject&lt;?&gt; cnative =  vm.resolveClass(&quot;com/roysue/testfindcalss/MainActivity&quot;);</span><br>        <span class="hljs-comment">// 不是静态，则jObject，需要new</span><br>        <span class="hljs-comment">//DvmObject&lt;?&gt; cnative =  vm.resolveClass(&quot;com/roysue/testfindcalss/MainActivity&quot;).newObject(null);</span><br>        <span class="hljs-comment">//list.add(cnative.hashCode());  |  list.add(vm.addLocalObject(cnative));  </span><br><br>        <span class="hljs-comment">// arg3 bytes</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;aid=01A-khBWIm48A079Pz_DMW6PyZR8&quot;</span>;<br>        <span class="hljs-type">byte</span>[] inputByte = input.getBytes(StandardCharsets.UTF_8);<br>        <span class="hljs-type">ByteArray</span> <span class="hljs-variable">inputByteArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArray</span>(vm,inputByte);<br>        <span class="hljs-comment">// 因为JNI调用java的话，非基础类型要加全局引用，所以都要使用addLocalObject</span><br>        list.add(vm.addLocalObject(inputByteArray));  <br>        <span class="hljs-comment">// arg4 ,boolean false 填入0</span><br>        list.add(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 参数准备完成</span><br>        <span class="hljs-comment">// call function</span><br>        <span class="hljs-type">Number</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">module</span>.callFunction(emulator, <span class="hljs-number">0xC365</span>, list.toArray())[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> vm.getObject(number.intValue()).getValue().toString();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="通过执行导出方法名"><a href="#通过执行导出方法名" class="headerlink" title="通过执行导出方法名"></a>通过执行导出方法名</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.issue;<br><br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.*;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.array.ArrayObject;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><span class="hljs-keyword">import</span> com.github.unidbg.Module;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">day0801</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Module <span class="hljs-keyword">module</span>;<br><br>    day0801()&#123;<br><br>        <span class="hljs-comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span><br>        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="hljs-string">&quot;com.sankuai.meituan.meituanwaimaibusiness&quot;</span>).build();<br>        <span class="hljs-comment">// 获取模拟器的内存操作接口</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> emulator.getMemory();<br>        <span class="hljs-comment">// 设置系统类库解析</span><br>        memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br>        <span class="hljs-comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span><br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android\\src\\test\\resources\\example_binaries\\apk\\mtmj6.22.0.67.apk&quot;</span>));<br>        <span class="hljs-comment">// 加载目标SO</span><br>        <span class="hljs-type">DalvikModule</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span> vm.loadLibrary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android\\src\\test\\resources\\example_binaries\\apk\\libPayRequestCrypt.so&quot;</span>), <span class="hljs-literal">true</span>); <span class="hljs-comment">// 加载so到虚拟内存</span><br>        <span class="hljs-comment">//获取本SO模块的句柄,后续需要用它</span><br>        <span class="hljs-keyword">module</span> = dm.getModule();<br>        vm.setJni(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 设置JNI</span><br>        vm.setVerbose(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 打印日志</span><br>        dm.callJNI_OnLoad(emulator); <span class="hljs-comment">// 调用JNI OnLoad</span><br><br>    &#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callByAddress</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// args list</span><br>        List&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">// jnienv</span><br>        list.add(vm.getJNIEnv());<br>        <span class="hljs-comment">// jclazz</span><br>        list.add(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// str1</span><br>        list.add(vm.addLocalObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str1&quot;</span>)));<br>        <span class="hljs-comment">// str2</span><br>        list.add(vm.addLocalObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str2&quot;</span>)));<br>        <span class="hljs-comment">// str3</span><br>        list.add(vm.addLocalObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str3&quot;</span>)));<br>        <span class="hljs-comment">// str4</span><br>        list.add(vm.addLocalObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str4&quot;</span>)));<br>        <span class="hljs-comment">// str5</span><br>        list.add(vm.addLocalObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str5&quot;</span>)));<br>        <span class="hljs-comment">// strArr 假设字符串包含两个字符串</span><br>        <span class="hljs-comment">// str6_1</span><br>        <span class="hljs-type">StringObject</span> <span class="hljs-variable">str6_1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str6_1&quot;</span>);<br>        vm.addLocalObject(str6_1);<br>        <span class="hljs-comment">// str6_2</span><br>        <span class="hljs-type">StringObject</span> <span class="hljs-variable">str6_2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str6_2&quot;</span>);<br>        vm.addLocalObject(str6_2);<br><br>        <span class="hljs-type">ArrayObject</span> <span class="hljs-variable">arrayObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayObject</span>(str6_1,str6_2);<br>        list.add(vm.addLocalObject(arrayObject));<br><br>        <span class="hljs-comment">// 最后的int</span><br>        list.add(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Number</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">module</span>.callFunction(emulator, <span class="hljs-number">0x2301</span>, list.toArray())[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">ArrayObject</span> <span class="hljs-variable">resultArr</span> <span class="hljs-operator">=</span> vm.getObject(number.intValue());<br>        System.out.println(<span class="hljs-string">&quot;result:&quot;</span>+resultArr);<br>    &#125;;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callMethodByApi</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 1、需要调用函数所在的Java类完整路径，比如a/b/c/d等等，注意需要用/代替.</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">classPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com/roysue/testfindcalss/MainActivity&quot;</span>;<br>        <span class="hljs-comment">// 2、需要调用函数的函数签名，我这里调用EncryptUtils中的getGameKey方法，由于此方法没有参数列表，所以不需要传入</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">methodSign</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;testGetMethodId()Ljava/lang/String&quot;</span>;<br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">RequestCryptUtils</span> <span class="hljs-operator">=</span> vm.resolveClass(classPath);<br>        System.out.println(RequestCryptUtils.callStaticJniMethodObject(emulator, methodSign, <span class="hljs-string">&quot;&quot;</span>));<br>&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callByAPI</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">RequestCryptUtils</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com/meituan/android/payguard/RequestCryptUtils&quot;</span>);<br><br>        <span class="hljs-type">StringObject</span> <span class="hljs-variable">str6_1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str6_1&quot;</span>);<br>        vm.addLocalObject(str6_1);<br>        <span class="hljs-type">StringObject</span> <span class="hljs-variable">str6_2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;str6_2&quot;</span>);<br>        vm.addLocalObject(str6_2);<br>        <span class="hljs-type">ArrayObject</span> <span class="hljs-variable">arrayObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayObject</span>(str6_1,str6_2);<br><br>        <span class="hljs-type">ArrayObject</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> RequestCryptUtils.callStaticJniMethodObject(emulator, <span class="hljs-string">&quot;encryptRequestWithRandom()&quot;</span>, <span class="hljs-string">&quot;str1&quot;</span>,<span class="hljs-string">&quot;str2&quot;</span>, <span class="hljs-string">&quot;str3&quot;</span>,<span class="hljs-string">&quot;str4&quot;</span>,<span class="hljs-string">&quot;str5&quot;</span>,arrayObject,<span class="hljs-number">1</span>);<br>        System.out.println(result);<br>    &#125;;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">day0801</span> <span class="hljs-variable">mt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">day0801</span>();<br>        mt.callByAPI();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.bilibili;<br><br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.arm.backend.Unicorn2Factory;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.AbstractJni;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.DalvikModule;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.DvmClass;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.VM;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">xvideo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DvmClass NativeApi;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">xvideo</span><span class="hljs-params">()</span> &#123;<br>        emulator = AndroidEmulatorBuilder<br>                .for64Bit()<br>                <span class="hljs-comment">// 设置根目录</span><br>     	     .setRootDir(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;target/rootfs&quot;</span>))<br>                <span class="hljs-comment">// 后端：Unidbg 支持后端共五个Backed： Unicorn、Unicorn2、Dynarmic、Hypervisor、KVM。如果不添加 BackendFactory，默认使用 Unicorn Backend</span><br>                <span class="hljs-comment">// 各种 BackendFactory 的构造方法都要传入fallbackUnicorn，这是一个布尔型参数，它表示如果这个后端创建失败时如何处理——报错还是回退到Unicorn Backend</span><br>                <span class="hljs-comment">// 相比较 Unicorn，Unidbg 基于 Unicorn2 设计和实现了多线程的相关逻辑，因此在 Unicorn 和 Unicorn2 之间，应该选择 Unicorn2</span><br>                .addBackendFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Unicorn2Factory</span>(<span class="hljs-literal">true</span>))<br>                <span class="hljs-comment">// 设置进程名；程序通过getprogname库函数获取进程名时，获取到的就是它；不设置则返回unidbg</span><br>                .setProcessName(<span class="hljs-string">&quot;com.sina.oasis&quot;</span>)  <br>                .build();<br><br>        <span class="hljs-comment">// 多线程：个人建议在模拟执行相对复杂的样本时，就打开多线程；如果样本难度一般，就不必打开。</span><br>        <span class="hljs-comment">// 设置执行多少条指令切换一次线程</span><br>        emulator.getBackend().registerEmuCountHook(<span class="hljs-number">10000</span>);<br>        <span class="hljs-comment">// 开启线程调度器</span><br>        emulator.getSyscallHandler().setEnableThreadDispatcher(<span class="hljs-literal">true</span>);<br>        <br>        <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> emulator.getMemory();<br>        memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;unidbg-android/src/test/resources/bilibili/lvzhou.apk&quot;</span>));<br>        vm.setJni(<span class="hljs-built_in">this</span>);<br>        vm.setVerbose(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">DalvikModule</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span> vm.loadLibrary(<span class="hljs-string">&quot;oasiscore&quot;</span>, <span class="hljs-literal">true</span>);<br>        NativeApi = vm.resolveClass(<span class="hljs-string">&quot;com/weibo/xvideo/NativeApi&quot;</span>);<br>        dm.callJNI_OnLoad(emulator);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">calls</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">arg1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;aid=01A-khBWIm48A079Pz_DMW6PyZR8uyTumcCNm4e8awxyC2ANU.&amp;cfrom=28B5295010&amp;cuid=5999578300&amp;noncestr=46274W9279Hr1X49A5X058z7ZVz024&amp;platform=ANDROID&amp;timestamp=1621437643609&amp;ua=Xiaomi-MIX2S__oasis__3.5.8__Android__Android10&amp;version=3.5.8&amp;vid=1019013594003&amp;wm=20004_90024&quot;</span>;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">arg2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> NativeApi.newObject(<span class="hljs-literal">null</span>).callJniMethodObject(emulator, <span class="hljs-string">&quot;s([BZ)Ljava/lang/String;&quot;</span>, arg1.getBytes(StandardCharsets.UTF_8), arg2).getValue().toString();<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">xvideo</span> <span class="hljs-variable">xv</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">xvideo</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> xv.calls();<br>        System.out.println(<span class="hljs-string">&quot;call s result:&quot;</span>+result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







































                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2025/05/04/逆向/安卓逆向/6. 模拟执行/Unidbg/1. 入门/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年5月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2025/05/04/%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/6.%20%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/Unidbg/%E8%A1%A5%E7%8E%AF%E5%A2%83/%E8%A1%A5%E7%8E%AF%E5%A2%83%E6%B5%81%E7%A8%8B/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2025/05/04/%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/6.%20%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/AndroidNativeEmu/1.%20%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/blog/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/blog/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/blog/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
